name: Reveal Location (J-6 18:00 Europe/Paris)

on:
  workflow_dispatch: {}   # lancement manuel

jobs:
  reveal:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Guard correct year
        run: |
          YEAR=$(date +'%Y')
          if [ "$YEAR" -gt 2025 ]; then
            echo "⏹ Too late: event year already passed ($YEAR)"
            exit 1
          fi

      - name: Install jq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Write location.json from secrets (safe JSON)
        run: |
          if [ -n "${{ secrets.LOCATION_HTML }}" ]; then
            jq -Rn --arg html "${{ secrets.LOCATION_HTML }}" '{html:$html}' > location.json
          elif [ -n "${{ secrets.LOCATION_VALUE }}" ]; then
            jq -Rn --arg location "${{ secrets.LOCATION_VALUE }}" '{location:$location}' > location.json
          else
            echo "❌ Missing LOCATION_HTML or LOCATION_VALUE secret."
            exit 1
          fi
          echo "location.json:"
          cat location.json

      - name: Commit & push (only if changed)
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # S'assurer que le fichier est suivi et détecter un vrai changement
          git add -N location.json
          if git diff --quiet --exit-code -- location.json; then
            echo "✅ No changes to commit. Exiting successfully."
            exit 0
          fi

          git add location.json
          git commit -m "Update location.json (reveal/location)"
          git push
