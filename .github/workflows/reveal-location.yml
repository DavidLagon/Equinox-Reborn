name: Reveal Location (J-6 18:00 Europe/Paris)

on:
  workflow_dispatch: {}         # bouton "Run workflow"
  schedule:
    - cron: '0 17 30 11 *'      # 30 novembre à 17:00 UTC = 18:00 Europe/Paris

jobs:
  reveal:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # (Optionnel) garde-fou pour éviter d'exécuter après l'année de l'événement
      - name: Guard correct year
        run: |
          YEAR=$(date +'%Y')
          if [ "$YEAR" -gt 2025 ]; then
            echo "⏹ Too late: event year already passed ($YEAR)"
            exit 0
          fi

      - name: Install jq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Write location.json from secrets (safe JSON)
        run: |
          if [ -n "${{ secrets.LOCATION_HTML }}" ]; then
            jq -Rn --arg html "${{ secrets.LOCATION_HTML }}" '{html:$html}' > location.json
          elif [ -n "${{ secrets.LOCATION_VALUE }}" ]; then
            jq -Rn --arg location "${{ secrets.LOCATION_VALUE }}" '{location:$location}' > location.json
          else
            echo "❌ Missing LOCATION_HTML or LOCATION_VALUE secret."
            exit 1
          fi
          echo "location.json generated:"
          cat location.json

      - name: Commit & push (only if changed)
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add -N location.json
          if git diff --quiet --exit-code -- location.json; then
            echo "✅ No changes to commit. Exiting successfully."
            exit 0
          fi

          git add location.json
          git commit -m "Update location.json (auto reveal J-6 18:00 Europe/Paris)"
          git push
