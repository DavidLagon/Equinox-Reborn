name: Reveal Location (J-6 18:00 Europe/Paris)

on:
  workflow_dispatch:

jobs:
  reveal:
    runs-on: ubuntu-latest

    steps:
      - name: Set up job
        run: echo "Starting reveal process..."

      - name: Checkout
        uses: actions/checkout@v4

      - name: Guard correct year
        run: |
          YEAR=$(date +'%Y')
          if [ "$YEAR" -gt 2025 ]; then
            echo "⏹ Too late: event year already passed ($YEAR)"
            exit 1
          fi

      - name: Write location.json from secrets
        run: |
          mkdir -p .
          # Priorité à LOCATION_HTML si elle existe, sinon LOCATION_VALUE
          if [ -n "${{ secrets.LOCATION_HTML }}" ]; then
            echo "{\"html\": \"${{ secrets.LOCATION_HTML }}\"}" > location.json
          elif [ -n "${{ secrets.LOCATION_VALUE }}" ]; then
            echo "{\"location\": \"${{ secrets.LOCATION_VALUE }}\"}" > location.json
          else
            echo "❌ Missing LOCATION_HTML or LOCATION_VALUE secret."
            exit 1
          fi
          cat location.json

      - name: Commit & push (only if changed)
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # S'assurer que le fichier est suivi
          git add -N location.json

          # Vérifie s'il y a une différence
          if git diff --quiet --exit-code -- location.json; then
            echo "✅ No changes to commit. Exiting successfully."
            exit 0
          fi

          git add location.json
          git commit -m "Update location.json (reveal/location)"
          git push
